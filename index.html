<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" 
  </style>
  <!-- html2canvas for export -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
</head>
<body>
  <div class="container">
    <header>
      <div>
        <h1>AgriSense.AI ‚Äî Farm ‚Üí Data Capture ‚Üí Analysis ‚Üí Insights ‚Üí Production</h1>
        <div class="small">Interactive flowchart ‚Äî integrates smart features for FMCG supply chain alignment</div>
      </div>

      <div class="controls">
        <div style="display:flex; gap:8px; align-items:center;">
          <label class="small">Skill:</label>
          <select id="skillSelect" class="chip">
            <option value="beginner">Beginner</option>
            <option value="intermediate" selected>Intermediate</option>
            <option value="expert">Expert</option>
          </select>
        </div>

        <div style="display:flex; gap:8px; align-items:center;">
          <label class="small">Version:</label>
          <div class="version-toggle chip">
            <input type="radio" name="ver" id="v1" value="v1" checked> <label for="v1">v1</label>
            &nbsp;
            <input type="radio" name="ver" id="v2" value="v2"> <label for="v2">v2</label>
          </div>
        </div>

        <button class="btn" id="exportBtn">Export PNG</button>
        <button class="btn secondary" id="resetBtn">Reset Highlights</button>
      </div>
    </header>

    <div class="card">
      <div class="flow-wrap" id="flowRoot">
        <!-- Farm node -->
        <div class="node" id="node-farm" data-key="farm" style="background:var(--accent3);">
          <div class="icon">üöú</div>
          <h3>Farm</h3>
          <p class="subtitle">Sensors & field teams</p>
        </div>

        <!-- connector -->
        <div class="connector" aria-hidden><svg class="arrow" viewBox="0 0 24 24"><path d="M3 12h14l-4 4" fill="none" stroke="#3b82f6" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg></div>

        <!-- Data Capture / IoT node -->
        <div class="node" id="node-capture" data-key="capture" style="background:var(--accent1);">
          <div class="icon">üì°</div>
          <h3>Data Capture</h3>
          <p class="subtitle">IoT sensors, drones, mobile apps</p>
        </div>

        <div class="connector" aria-hidden><svg class="arrow" viewBox="0 0 24 24"><path d="M3 12h14l-4 4" fill="none" stroke="#06b6d4" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg></div>

        <!-- AgriSense.AI / Analysis -->
        <div class="node" id="node-analysis" data-key="analysis" style="background:var(--accent2); color:#051226;">
          <div class="icon">‚òÅÔ∏è</div>
          <h3>AgriSense.AI</h3>
          <p class="subtitle">Cloud analytics, ML models</p>
        </div>

        <div class="connector" aria-hidden><svg class="arrow" viewBox="0 0 24 24"><path d="M3 12h14l-4 4" fill="none" stroke="#7c3aed" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg></div>

        <!-- Production -->
        <div class="node" id="node-prod" data-key="production" style="background:linear-gradient(135deg,#ffb86b,#ff8b8b); color:#102331;">
          <div class="icon">üè≠</div>
          <h3>Production</h3>
          <p class="subtitle">FMCG procurement & manufacturing</p>
        </div>
      </div>

      <!-- Details panel (left: node info, right: insights, palette, tools) -->
      <div class="panel">
        <div class="left">
          <div class="details card" id="detailsBox">
            <h3 id="d-title">Click a node to view details</h3>
            <div id="d-desc" class="small">Nodes explain their function, recommended tools, and AI suggestions.</div>

            <div style="margin-top:12px;">
              <div style="display:flex; gap:8px; align-items:center; margin-bottom:8px;">
                <div class="chip">Impact</div>
                <div class="chip">Sustainability</div>
                <div class="chip">Traceability</div>
              </div>

              <div id="d-tools" style="margin-top:8px;">
                <strong>Recommended tools:</strong>
                <div class="meta" id="toolsMeta" style="margin-top:8px">
                  <!-- injected -->
                </div>
              </div>

              <div id="d-metrics" style="margin-top:12px;">
                <strong>Sample Metrics:</strong>
                <div style="margin-top:8px" id="metricsList" class="small">
                  <!-- injected -->
                </div>
              </div>

              <div style="margin-top:10px;">
                <strong>AI Step Recommender</strong>
                <div class="small" id="aiRecommender" style="margin-top:6px">Choose a node + skill level to get a suggested next step.</div>
              </div>
            </div>
          </div>

          <!-- color mini-map -->
          <div style="margin-top:14px;" class="card details">
            <strong>Color Palette Suggestions</strong>
            <div class="swatches" id="swatches">
              <div class="swatch" style="background:linear-gradient(135deg,#1fa2ff,#12d8fa)">A</div>
              <div class="swatch" style="background:linear-gradient(135deg,#7afcff,#b692ff)">B</div>
              <div class="swatch" style="background:linear-gradient(135deg,#7be495,#2bb673)">C</div>
              <div class="swatch" style="background:linear-gradient(135deg,#ffb86b,#ff8b8b)">D</div>
            </div>
            <div class="small" style="margin-top:10px">Use Palette C for "agriculture" branding; Palette B for analytics dashboards; Palette D for production/warning states.</div>
          </div>
        </div>

        <div class="right">
          <div class="card details">
            <strong>AI  Tips (quick)</strong>
            <div class="prompt" id="promptBox">
#  "Isometric smart farm with sensors and cloud analytics, modern blue/green palette, photorealistic"
# StableDiffusion: "agritech dashboard UI, data visualizations, farmers interacting with tablets, clean design"
# Analysis prompt: "Given sensor dataset [soil_moisture,temp,ndvi], predict weekly yield and irrigation schedule"
            </div>

            <div style="margin-top:12px;">
              <strong>Version Comparison</strong>
              <div class="small" style="margin-top:6px">Toggle Version to compare feature set:</div>
              <ul id="versionList" class="small" style="margin-top:8px">
                <!-- injected -->
              </ul>
            </div>

            <div style="margin-top:12px;">
              <strong>Export / Deliverables</strong>
              <div class="small" style="margin-top:6px">
                ‚Ä¢ Slide-ready PNG export (use Export PNG).<br>
                ‚Ä¢ Exported metrics & CSV (demo) ‚Äî integrate with procurement ERPs via API.<br>
                ‚Ä¢ Suggest adding pilot results (3 farms x 2 months) in appendix.
              </div>
            </div>

            <div style="margin-top:12px;">
              <strong>Admin Actions</strong>
              <div style="margin-top:8px; display:flex; gap:8px;">
                <button class="btn" id="suggestBtn">Get AI Suggestion</button>
                <button class="btn secondary" id="downloadCSV">Download CSV (demo)</button>
              </div>
            </div>

          </div>
        </div>
      </div>
    </div>

    <footer style="margin-top:14px; text-align:center; color:var(--muted); font-size:13px">
      Tip: Click nodes to open detailed guidance. Use the skill slider to change the AI Recommendations (Beginner‚ÄîExpert).
    </footer>
  </div>

  <script>
    // Data definitions for each node
    const NODES = {
      farm: {
        title: 'Farm',
        desc: 'On-field teams, tractors, crop plots. Sensors (soil moisture, temperature), drones for NDVI, and mobile apps for farmer inputs.',
        tools: ['LoRa sensors (e.g., Dragino)', 'Mobile app (Android/iOS)', 'Drones (NDVI imagery)'],
        metrics: ['Soil moisture (%)','NDVI index','Growth stage','Harvest estimate (kg)'],
        version: { v1:'Manual sensors + mobile logging', v2:'Drone imagery + automated soil probes' }
      },
      capture: {
        title: 'Data Capture',
        desc: 'Edge gateways collect telemetry, pre-process and forward to cloud. Use secure comms (TLS) and batching to optimize bandwidth.',
        tools: ['Edge Gateway (Raspberry Pi)', 'MQTT / LoRaWAN', 'Preprocessing pipeline (JSON->Parquet)'],
        metrics: ['Message latency (ms)','Data completeness (%)','Packet loss (%)'],
        version: { v1:'MQTT ingestion', v2:'MQTT + edge aggregation + OTA updates' }
      },
      analysis: {
        title: 'AgriSense.AI',
        desc: 'Cloud-hosted ML models ‚Äî yield prediction, irrigation optimizer, anomaly detection and quality scoring for procurement decisions.',
        tools: ['AWS/GCP/Azure', 'Model: RandomForest / LSTM', 'Dashboard: React + Plotly'],
        metrics: ['Yield prediction error (%)','Water saving (%)','Time to decision (hours)'],
        version: { v1:'Basic ML models + dashboard', v2:'AutoML + supply chain integration + API for procurement' }
      },
      production: {
        title: 'Production',
        desc: 'FMCG procurement teams consume insights for sourcing schedules, dynamic pricing, and production planning (e.g., pigment sourcing).',
        tools: ['Procurement ERP (SAP/Oracle)', 'Supplier portal', 'Quality inspection integration'],
        metrics: ['Procurement cost variance (%)','On-time delivery (%)','Quality acceptance rate (%)'],
        version: { v1:'Manual procurement updates', v2:'Automated S2P pipeline with supplier scoring' }
      }
    };

    const nodeElems = document.querySelectorAll('.node');
    const detailsTitle = document.getElementById('d-title');
    const detailsDesc = document.getElementById('d-desc');
    const toolsMeta = document.getElementById('toolsMeta');
    const metricsList = document.getElementById('metricsList');
    const aiRecommender = document.getElementById('aiRecommender');
    const skillSelect = document.getElementById('skillSelect');
    const versionList = document.getElementById('versionList');
    const exportBtn = document.getElementById('exportBtn');
    const resetBtn = document.getElementById('resetBtn');
    const suggestBtn = document.getElementById('suggestBtn');
    const downloadCSV = document.getElementById('downloadCSV');

    // populate version list initially
    function updateVersionList(ver='v1'){
      versionList.innerHTML = '';
      for(const k of Object.keys(NODES)){
        const vText = NODES[k].version[ver] || '';
        const li = document.createElement('li');
        li.textContent = `‚Ä¢ ${NODES[k].title}: ${vText}`;
        versionList.appendChild(li);
      }
    }
    updateVersionList('v1');

    // node click handler
    nodeElems.forEach(ne=>{
      ne.addEventListener('click', ()=>{
        const key = ne.dataset.key;
        showDetails(key);
        highlightNode(ne);
      });
    });

    // show details
    function showDetails(key){
      const data = NODES[key];
      detailsTitle.textContent = data.title;
      detailsDesc.textContent = data.desc;
      // tools
      toolsMeta.innerHTML = '';
      data.tools.forEach(t=>{
        const d = document.createElement('div');
        d.className = 'chip';
        d.style.background='rgba(255,255,255,0.9)';
        d.textContent = t;
        toolsMeta.appendChild(d);
      });
      // metrics
      metricsList.innerHTML = '';
      data.metrics.forEach(m=>{
        const d = document.createElement('div');
        d.textContent = '‚Ä¢ ' + m;
        metricsList.appendChild(d);
      });
      // AI recommender initial
      updateAiRecommendation(key, skillSelect.value);
    }

    // highlight selection
    function highlightNode(elem){
      nodeElems.forEach(n=> n.style.opacity = '0.95');
      elem.style.boxShadow = '0 28px 60px rgba(16,24,40,0.12)';
      elem.style.transform = 'translateY(-8px) scale(1.02)';
    }

    // reset
    resetBtn.addEventListener('click', ()=>{
      nodeElems.forEach(n=> { n.style.transform='none'; n.style.boxShadow='0 6px 18px rgba(12,18,36,0.08)'; n.style.opacity=1;});
      detailsTitle.textContent = 'Click a node to view details';
      detailsDesc.textContent = 'Nodes explain their function, recommended tools, and AI suggestions.';
      toolsMeta.innerHTML = '';
      metricsList.innerHTML = '';
      aiRecommender.textContent = 'Choose a node + skill level to get a suggested next step.';
    });

    // update AI suggestion (simple rule-based demo)
    function updateAiRecommendation(nodeKey, skill){
      const base = {
        farm: {
          beginner: 'Collect daily soil moisture readings and log farmer reports via mobile app.',
          intermediate: 'Set up LoRa soil probes + weekly NDVI drone flights; begin baseline model training.',
          expert: 'Deploy edge analytics with anomaly detection; integrate satellite imagery and genomic data.'
        },
        capture: {
          beginner: 'Use an off-the-shelf gateway and push MQTT messages to cloud every 15 min.',
          intermediate: 'Implement edge preprocessing and retry logic; batch to reduce costs.',
          expert: 'Use adaptive sampling, OTA firmware updates, and encrypted streams with schema registry.'
        },
        analysis: {
          beginner: 'Run a regression model to predict yield and visualize in a simple dashboard.',
          intermediate: 'Train ensemble models (RF + XGBoost) and create irrigation optimizer.',
          expert: 'Deploy LSTM for temporal forecasting, AutoML pipelines, and API endpoints for procurement ERP.'
        },
        production: {
          beginner: 'Share weekly CSV insights with procurement and set manual reorder points.',
          intermediate: 'Automate procurement alerts & supplier scoring based on quality predictions.',
          expert: 'Integrate with S2P systems to auto-trigger purchase orders and dynamic pricing contracts.'
        }
      };
      aiRecommender.textContent = base[nodeKey][skill] || 'No suggestion available.';
    }

    // skill change event updates recommender if node selected
    skillSelect.addEventListener('change', ()=>{
      const selectedNode = document.querySelector('.node[style*="transform: translateY(-8px)"]') || document.querySelector('.node[style*="transform: translateY(-8px) scale(1.02)"]');
      // fallback: try reading detailsTitle to map back to key
      const title = detailsTitle.textContent;
      let key = null;
      for(const k in NODES){ if(NODES[k].title === title) key=k; }
      if(key) updateAiRecommendation(key, skillSelect.value);
    });

    // version radio change
    document.querySelectorAll('input[name="ver"]').forEach(r=>{
      r.addEventListener('change', ()=>{
        updateVersionList(r.value);
      });
    });

    // export flowchart root to PNG using html2canvas
    exportBtn.addEventListener('click', async ()=>{
      exportBtn.disabled = true;
      exportBtn.textContent = 'Exporting...';
      const root = document.querySelector('.card'); // export the main card
      const orig = root.style.background;
      // ensure white bg for clean image
      root.style.background = '#ffffff';
      try{
        const canvas = await html2canvas(root, {scale:2, backgroundColor: '#ffffff'});
        const link = document.createElement('a');
        link.download = 'AgriSense_flowchart.png';
        link.href = canvas.toDataURL('image/png');
        link.click();
      }catch(err){
        alert('Export failed: ' + err.message);
      }finally{
        root.style.background = orig;
        exportBtn.disabled = false;
        exportBtn.textContent = 'Export PNG';
      }
    });

    // Suggest AI button ‚Äî will call recommender based on currently selected node or default to analysis
    suggestBtn.addEventListener('click', ()=>{
      const title = detailsTitle.textContent;
      let key = null;
      for(const k in NODES){ if(NODES[k].title === title) key=k; }
      if(!key) key = 'analysis';
      updateAiRecommendation(key, skillSelect.value);
      // highlight briefly
      const el = document.querySelector(`[data-key="${key}"]`);
      if(el){
        el.style.boxShadow = '0 28px 60px rgba(20,100,200,0.16)';
        setTimeout(()=> el.style.boxShadow='0 6px 18px rgba(12,18,36,0.08)', 2000);
      }
    });

    // downloadCSV: create dummy csv and download (demo)
    downloadCSV.addEventListener('click', ()=>{
      const csv = 'farm_id,date,soil_moisture,ndvi,predicted_yield\\n1,2025-10-01,32,0.72,1200\\n2,2025-10-01,28,0.68,980\\n';
      const blob = new Blob([csv], {type:'text/csv'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url; a.download = 'agrisense_sample.csv'; a.click();
      URL.revokeObjectURL(url);
    });

    // initialize with analysis node selected
    showDetails('analysis');
    // subtle initial highlight
    document.getElementById('node-analysis').style.boxShadow = '0 18px 40px rgba(12,18,36,0.12)';
  </script>
</body>
</html>
