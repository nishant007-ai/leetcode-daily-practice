

    <footer style="margin-top:14px; text-align:center; color:var(--muted); font-size:13px">
      Tip: Click nodes to open detailed guidance. Use the skill slider to change the AI Recommendations (Beginner—Expert).
    </footer>
  </div>
      },

    const nodeElems = document.querySelectorAll('.node');
    const detailsTitle = document.getElementById('d-title');
    const detailsDesc = document.getElementById('d-desc');
    const toolsMeta = document.getElementById('toolsMeta');
    const metricsList = document.getElementById('metricsList');
    const aiRecommender = document.getElementById('aiRecommender');
    const skillSelect = document.getElementById('skillSelect');
    const versionList = document.getElementById('versionList');
    const exportBtn = document.getElementById('exportBtn');
    const resetBtn = document.getElementById('resetBtn');
    const suggestBtn = document.getElementById('suggestBtn');
    const downloadCSV = document.getElementById('downloadCSV');

    // populate version list initially
    function updateVersionList(ver='v1'){
      versionList.innerHTML = '';
      for(const k of Object.keys(NODES)){
        const vText = NODES[k].version[ver] || '';
        const li = document.createElement('li');
        li.textContent = `• ${NODES[k].title}: ${vText}`;
        versionList.appendChild(li);
      }
    }
    updateVersionList('v1');

    // node click handler
    nodeElems.forEach(ne=>{
      ne.addEventListener('click', ()=>{
        const key = ne.dataset.key;
        showDetails(key);
        highlightNode(ne);
      });
    });

    // show details
    function showDetails(key){
      const data = NODES[key];
      detailsTitle.textContent = data.title;
      detailsDesc.textContent = data.desc;
      // tools
      toolsMeta.innerHTML = '';
      data.tools.forEach(t=>{
        const d = document.createElement('div');
        d.className = 'chip';
        d.style.background='rgba(255,255,255,0.9)';
        d.textContent = t;
        toolsMeta.appendChild(d);
      });
      // metrics
      metricsList.innerHTML = '';
      data.metrics.forEach(m=>{
        const d = document.createElement('div');
        d.textContent = '• ' + m;
        metricsList.appendChild(d);
      });
      // AI recommender initial
      updateAiRecommendation(key, skillSelect.value);
    }

    // highlight selection
    function highlightNode(elem){
      nodeElems.forEach(n=> n.style.opacity = '0.95');
      elem.style.boxShadow = '0 28px 60px rgba(16,24,40,0.12)';
      elem.style.transform = 'translateY(-8px) scale(1.02)';
    }

    // reset
    resetBtn.addEventListener('click', ()=>{
      nodeElems.forEach(n=> { n.style.transform='none'; n.style.boxShadow='0 6px 18px rgba(12,18,36,0.08)'; n.style.opacity=1;});
      detailsTitle.textContent = 'Click a node to view details';
      detailsDesc.textContent = 'Nodes explain their function, recommended tools, and AI suggestions.';
      toolsMeta.innerHTML = '';
      metricsList.innerHTML = '';
      aiRecommender.textContent = 'Choose a node + skill level to get a suggested next step.';
    });

    // update AI suggestion (simple rule-based demo)
    function updateAiRecommendation(nodeKey, skill){
      const base = {
        farm: {
          beginner: 'Collect daily soil moisture readings and log farmer reports via mobile app.',
          intermediate: 'Set up LoRa soil probes + weekly NDVI drone flights; begin baseline model training.',
          expert: 'Deploy edge analytics with anomaly detection; integrate satellite imagery and genomic data.'
        },
        capture: {
          beginner: 'Use an off-the-shelf gateway and push MQTT messages to cloud every 15 min.',
          intermediate: 'Implement edge preprocessing and retry logic; batch to reduce costs.',
          expert: 'Use adaptive sampling, OTA firmware updates, and encrypted streams with schema registry.'
        },
        analysis: {
          beginner: 'Run a regression model to predict yield and visualize in a simple dashboard.',
          intermediate: 'Train ensemble models (RF + XGBoost) and create irrigation optimizer.',
          expert: 'Deploy LSTM for temporal forecasting, AutoML pipelines, and API endpoints for procurement ERP.'
        },
        production: {
          beginner: 'Share weekly CSV insights with procurement and set manual reorder points.',
          intermediate: 'Automate procurement alerts & supplier scoring based on quality predictions.',
          expert: 'Integrate with S2P systems to auto-trigger purchase orders and dynamic pricing contracts.'
        }
      };
      aiRecommender.textContent = base[nodeKey][skill] || 'No suggestion available.';
    }

    // skill change event updates recommender if node selected
    skillSelect.addEventListener('change', ()=>{
      const selectedNode = document.querySelector('.node[style*="transform: translateY(-8px)"]') || document.querySelector('.node[style*="transform: translateY(-8px) scale(1.02)"]');
      // fallback: try reading detailsTitle to map back to key
      const title = detailsTitle.textContent;
      let key = null;
      for(const k in NODES){ if(NODES[k].title === title) key=k; }
      if(key) updateAiRecommendation(key, skillSelect.value);
    });

    // version radio change
    document.querySelectorAll('input[name="ver"]').forEach(r=>{
      r.addEventListener('change', ()=>{
        updateVersionList(r.value);
      });
    });

    // export flowchart root to PNG using html2canvas
    exportBtn.addEventListener('click', async ()=>{
      exportBtn.disabled = true;
      exportBtn.textContent = 'Exporting...';
      const root = document.querySelector('.card'); // export the main card
      const orig = root.style.background;
      // ensure white bg for clean image
      root.style.background = '#ffffff';
      try{
        const canvas = await html2canvas(root, {scale:2, backgroundColor: '#ffffff'});
        const link = document.createElement('a');
        link.download = 'AgriSense_flowchart.png';
        link.href = canvas.toDataURL('image/png');
        link.click();
      }catch(err){
        alert('Export failed: ' + err.message);
      }finally{
        root.style.background = orig;
        exportBtn.disabled = false;
        exportBtn.textContent = 'Export PNG';
      }
    });

    // Suggest AI button — will call recommender based on currently selected node or default to analysis
    suggestBtn.addEventListener('click', ()=>{
      const title = detailsTitle.textContent;
      let key = null;
      for(const k in NODES){ if(NODES[k].title === title) key=k; }
      if(!key) key = 'analysis';
      updateAiRecommendation(key, skillSelect.value);
      // highlight briefly
      const el = document.querySelector(`[data-key="${key}"]`);
      if(el){
        el.style.boxShadow = '0 28px 60px rgba(20,100,200,0.16)';
        setTimeout(()=> el.style.boxShadow='0 6px 18px rgba(12,18,36,0.08)', 2000);
      }
    });

    // downloadCSV: create dummy csv and download (demo)
    downloadCSV.addEventListener('click', ()=>{
      const csv = 'farm_id,date,soil_moisture,ndvi,predicted_yield\\n1,2025-10-01,32,0.72,1200\\n2,2025-10-01,28,0.68,980\\n';
      const blob = new Blob([csv], {type:'text/csv'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url; a.download = 'agrisense_sample.csv'; a.click();
      URL.revokeObjectURL(url);
    });

    // initialize with analysis node selected
    showDetails('analysis');
    // subtle initial highlight
    document.getElementById('node-analysis').style.boxShadow = '0 18px 40px rgba(12,18,36,0.12)';
  </script>
</body>
</html>
